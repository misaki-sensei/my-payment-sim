<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>お客アプリ (PosiPay)</title>
    <link rel="stylesheet" href="style.css">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;500;700&display=swap" rel="stylesheet">
    
    <script type="text/javascript" src="qrcode.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.js"></script>
    
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-database-compat.js"></script>
    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyC8WKf1uoTOn8-HGPwu_GHJ_2MZpmaco10",
            authDomain: "my-paypay-sim-45735.firebaseapp.com",
            databaseURL: "https://my-paypay-sim-45735-default-rtdb.firebaseio.com/",
            projectId: "my-paypay-sim-45735",
            storageBucket: "my-paypay-sim-45735.firebasestorage.app",
            messagingSenderId: "310980051016",
            appId: "1:310980051016:web:38083c1005b783054b587d"
        };
        firebase.initializeApp(firebaseConfig);
        window.database = firebase.database(); 
    </script>
</head>
<body>

    <div class="container app-container" id="appContainer">
        <div class="header">
            <h1 class="app-title">お客アプリ</h1>
        </div>

        <div class="balance-section card">
            <p class="balance-label">現在の残高</p>
            <p class="balance" id="currentBalance">¥ 0</p>
        </div>

        <div class="main-payment-section" id="mainPaymentSection">
            <p class="section-description">店舗のQRコードを読み取って決済します</p>
            <button id="showQrReaderBtn" class="action-btn primary-btn large-btn">
                <span class="icon">📸</span> 店舗QRコードを読み取る
            </button>
            <button id="showChargeBtn" class="action-btn charge-toggle-btn large-btn">
                <span class="icon">➕</span> チャージする
            </button>
            <button id="showReceiveBtn" class="action-btn toggle-btn large-btn" style="margin-top: 15px;">
                <span class="icon">📥</span> お金を受け取る
            </button>
        </div>

        <div class="qr-reader-section hidden" id="qrReaderSection">
            <h2 class="section-title">QRコード読み取り</h2>
            <div class="card">
                <p class="qr-instruction">店舗のQRコードを映してください</p>
                
                <video id="qrCameraVideo" autoplay playsinline muted style="width: 100%; border-radius: 8px;"></video>
                <canvas id="qrCanvas" style="display:none;"></canvas>
                <div id="cameraStatus" style="text-align:center; margin-top:10px; color:#666;">カメラ起動中...</div>

                <p class="read-amount-display hidden" id="readAmountDisplay">
                    支払金額: <span id="scannedAmount">¥ 0</span>
                </p>

                <button id="confirmPayBtn" class="action-btn pay-btn hidden" style="margin-top: 15px;">
                    <span class="icon">💸</span> 支払いを確定する
                </button>
                <button id="cancelQrReadBtn" class="secondary-btn" style="margin-top: 15px;">キャンセル</button>
            </div>
        </div>

        <div id="receiveQrSection" class="section hidden card">
            <h2 class="section-title">お金を受け取る</h2>
            <div class="qr-display-container">
                <div id="receiveQrCode" class="qr-code-placeholder"></div>
                <p class="instruction-text">お店の人に読み取ってもらってください</p>
            </div>
            <button id="closeReceiveBtn" class="secondary-btn large-btn">戻る</button>
        </div>

        <div class="charge-section hidden" id="chargeSection">
            <h2 class="section-title">残高チャージ</h2>
            <div class="card">
                <div class="input-group">
                    <label for="chargeAmountInput">チャージ金額 (¥)</label>
                    <input type="number" id="chargeAmountInput" placeholder="金額を入力" inputmode="numeric">
                </div>
                <div class="predicted-balance-display" id="predictedBalanceDisplay">
                    チャージ後の残高: ¥ <span id="predictedBalance">0</span>
                </div>
                <button id="confirmChargeBtn" class="action-btn charge-toggle-btn">
                    <span class="icon">💳</span> チャージ実行
                </button>
                <button id="cancelChargeBtn" class="secondary-btn" style="margin-top: 15px;">キャンセル</button>
            </div>
        </div>

        <div class="payment-completion-section hidden" id="paymentCompletionSection">
            <div class="completion-card card">
                <div class="completion-icon" role="img" aria-label="決済完了">✅</div>
                <p class="completion-message">決済が完了しました！</p>
                <p class="completed-amount" id="completedAmount">¥ 0</p>
                <p class="thanks-message">ご利用ありがとうございます。</p>
                <p class="shop-id-display" id="completedShopId"></p>
            </div>
            <button id="backToMainFromCompletionBtn" class="primary-btn toggle-btn">メイン画面に戻る</button>
        </div>

        <div class="charge-completion-section hidden" id="chargeCompletionSection">
            <div class="completion-card card">
                <div class="completion-icon" role="img" aria-label="チャージ完了">➕</div>
                <p class="completion-message">チャージが完了しました！</p>
                <p class="completed-amount" id="chargedAmount">¥ 0</p>
                <p class="thanks-message">ご利用ありがとうございます。</p>
            </div>
            <button id="backToMainFromChargeCompletionBtn" class="primary-btn toggle-btn">メイン画面に戻る</button>
        </div>

        <div class="receive-completion-section hidden" id="receiveCompletionSection">
            <div class="completion-card card">
                <div class="completion-icon" role="img" aria-label="受取完了" style="background-color: #ff9800;">💰</div>
                <p class="completion-message">お金を受け取りました！</p>
                <p class="completed-amount" id="receivedAmountDisplay">¥ 0</p>
                <p class="thanks-message">残高に反映されました。</p>
            </div>
            <button id="backToMainFromReceiveBtn" class="primary-btn toggle-btn">メイン画面に戻る</button>
        </div>

        <div class="history-section card">
            <h2 class="section-title">支払い完了履歴</h2>
            <ul id="transactionHistory"></ul>
        </div>
    </div>

    <script src="customer_script.js"></script>
</body>
</html>
